import { NextRequest, NextResponse } from 'next/server'
import { performSEOAnalysis } from '@/lib/seoUtils'
import { generateAdvancedTags } from '@/lib/tagUtils'

export async function POST(request: NextRequest) {
  try {
    const { 
      title, 
      content, 
      author = 'JUNYA ISHIHARA',
      publishedAt = new Date().toISOString(),
      imageUrl,
      existingTags = [],
      existingPosts = []
    } = await request.json()

    if (!title || !content) {
      return NextResponse.json(
        { error: 'Title and content are required' },
        { status: 400 }
      )
    }

    // ã¾ãšã‚¿ã‚°ã‚’è‡ªå‹•ç”Ÿæˆ
    const tagAnalysis = generateAdvancedTags(content, title, 0.2)
    const autoTags = tagAnalysis.map(analysis => analysis.tag)
    
    // æ—¢å­˜ã‚¿ã‚°ã¨è‡ªå‹•ç”Ÿæˆã‚¿ã‚°ã‚’çµ„ã¿åˆã‚ã›
    const allTags = [...new Set([...existingTags, ...autoTags])]

    // SEOåˆ†æã‚’å®Ÿè¡Œ
    const seoAnalysis = performSEOAnalysis(
      title,
      content,
      allTags,
      author,
      publishedAt,
      imageUrl,
      existingPosts
    )

    // è¿½åŠ ã®SEOææ¡ˆã‚’ç”Ÿæˆ
    const additionalSuggestions = generateAdditionalSEOSuggestions(content, title, allTags)

    return NextResponse.json({
      ...seoAnalysis,
      autoGeneratedTags: autoTags,
      allTags,
      suggestions: [...seoAnalysis.suggestions, ...additionalSuggestions],
      analysis: {
        contentAnalysis: {
          wordCount: content.length,
          paragraphCount: content.split('\n\n').length,
          headingCount: (content.match(/#{1,6}\s/g) || []).length,
          listCount: (content.match(/^[\*\-\+]\s/gm) || []).length
        },
        keywordAnalysis: {
          primaryKeywords: seoAnalysis.keywords.slice(0, 3),
          secondaryKeywords: seoAnalysis.keywords.slice(3, 6),
          longTailKeywords: seoAnalysis.keywords.slice(6)
        },
        competitorAnalysis: generateCompetitorInsights(allTags)
      }
    })
  } catch (error) {
    console.error('Error performing SEO analysis:', error)
    return NextResponse.json(
      { error: 'Failed to perform SEO analysis' },
      { status: 500 }
    )
  }
}

// è¿½åŠ SEOææ¡ˆç”Ÿæˆ
function generateAdditionalSEOSuggestions(content: string, title: string, tags: string[]): string[] {
  const suggestions: string[] = []

  // ç”»åƒæœ€é©åŒ–
  if (!content.includes('![') && !content.includes('<img')) {
    suggestions.push('ğŸ“¸ ç”»åƒã‚’è¿½åŠ ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¦–è¦šçš„ã«è±Šã‹ã«ã—ã¾ã—ã‚‡ã†')
  }

  // FAQæ§‹é€ 
  if (!content.includes('?') && !content.includes('ï¼Ÿ')) {
    suggestions.push('â“ FAQå½¢å¼ã®è³ªå•ã‚’è¿½åŠ ã™ã‚‹ã¨æ¤œç´¢ã«å¼•ã£ã‹ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™')
  }

  // æ•°å€¤ãƒ‡ãƒ¼ã‚¿
  if ((content.match(/\d+/g) || []).length < 3) {
    suggestions.push('ğŸ“Š å…·ä½“çš„ãªæ•°å€¤ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹ã¨ä¿¡é ¼æ€§ãŒå‘ä¸Šã—ã¾ã™')
  }

  // å¼•ç”¨ãƒ»å‚è€ƒæ–‡çŒ®
  if (!content.includes('å‚è€ƒ') && !content.includes('å¼•ç”¨') && !content.includes('å‡ºå…¸')) {
    suggestions.push('ğŸ“š ä¿¡é ¼ã§ãã‚‹æƒ…å ±æºã¸ã®å‚ç…§ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†')
  }

  // ã‚³ãƒ¼ãƒ«ãƒ»ãƒˆã‚¥ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  if (!content.includes('ãŠå•ã„åˆã‚ã›') && !content.includes('ä½“é¨“') && !content.includes('ç›¸è«‡')) {
    suggestions.push('ğŸ¯ è¨˜äº‹ã®æœ€å¾Œã«ã‚³ãƒ¼ãƒ«ãƒ»ãƒˆã‚¥ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¡Œå‹•å–šèµ·ï¼‰ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†')
  }

  // ãƒ­ãƒ¼ã‚«ãƒ«SEOï¼ˆãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç‰¹åŒ–ï¼‰
  if (!content.includes('æ±äº¬') && !content.includes('åœ°åŸŸ') && !content.includes('è¿‘ã')) {
    suggestions.push('ğŸ“ åœ°åŸŸã«é–¢é€£ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚ã¦ãƒ­ãƒ¼ã‚«ãƒ«SEOã‚’å¼·åŒ–ã—ã¾ã—ã‚‡ã†')
  }

  return suggestions
}

// ç«¶åˆåˆ†æã‚¤ãƒ³ã‚µã‚¤ãƒˆ
function generateCompetitorInsights(tags: string[]): any {
  const insights = {
    fitnessMarket: {
      competition: 'HIGH',
      opportunity: [],
      trends: []
    },
    recommendedKeywords: [],
    contentGaps: []
  }

  // ã‚¿ã‚°ã«åŸºã¥ãå¸‚å ´åˆ†æ
  if (tags.includes('åˆå¿ƒè€…å‘ã‘')) {
    insights.fitnessMarket.opportunity.push('åˆå¿ƒè€…å‘ã‘ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯éœ€è¦ãŒé«˜ã„')
    insights.recommendedKeywords.push('ç­‹ãƒˆãƒ¬ åˆå¿ƒè€…', 'ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹ å§‹ã‚æ–¹')
  }

  if (tags.includes('ãƒ›ãƒ¼ãƒ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°')) {
    insights.fitnessMarket.trends.push('ãƒ›ãƒ¼ãƒ ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹å¸‚å ´ã¯æˆé•·ä¸­')
    insights.recommendedKeywords.push('è‡ªå®… ç­‹ãƒˆãƒ¬', 'å™¨å…·ãªã— ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°')
  }

  if (tags.includes('å¥³æ€§å‘ã‘')) {
    insights.fitnessMarket.opportunity.push('å¥³æ€§å‘ã‘ãƒ•ã‚£ãƒƒãƒˆãƒã‚¹å¸‚å ´ã¯æ‹¡å¤§ä¸­')
    insights.recommendedKeywords.push('å¥³æ€§ ç­‹ãƒˆãƒ¬', 'ãƒ€ã‚¤ã‚¨ãƒƒãƒˆ å¥³æ€§')
  }

  // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚®ãƒ£ãƒƒãƒ—åˆ†æ
  if (!tags.includes('æ „é¤Š')) {
    insights.contentGaps.push('æ „é¤Šé–¢é€£ã®æƒ…å ±ã‚’è¿½åŠ ã™ã‚‹ã¨åŒ…æ‹¬çš„ã«ãªã‚Šã¾ã™')
  }

  if (!tags.includes('æ€ªæˆ‘äºˆé˜²')) {
    insights.contentGaps.push('å®‰å…¨æ€§ãƒ»æ€ªæˆ‘äºˆé˜²ã®æƒ…å ±ãŒã‚ã‚‹ã¨ä¿¡é ¼æ€§ãŒå‘ä¸Šã—ã¾ã™')
  }

  return insights
}